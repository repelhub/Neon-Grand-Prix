<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Neon Grand Prix</title>
  <style>
    body {
      margin: 0;
      background: radial-gradient(circle at top, #120820, #020104);
      font-family: "Segoe UI", sans-serif;
      color: #fff;
      overflow: hidden;
    }
    #gameCanvas {
      display: block;
      margin: 10px auto;
      background: #050509;
      border: 2px solid #00eaff;
      box-shadow: 0 0 20px #00eaff;
    }
    #ui {
      text-align: center;
      margin-bottom: 5px;
    }
    #cashDisplay { color: #00ff88; }
    #carDisplay { color: #ffcc00; }
    #shop {
      text-align:center;
      font-size: 13px;
      color: #ccc;
      margin-bottom: 6px;
    }
    .shop-car {
      display:inline-block;
      border:1px solid #444;
      padding:4px 8px;
      margin:2px;
      cursor:pointer;
      border-radius:6px;
      background:#111;
    }
    .shop-car.owned {
      border-color:#00ff88;
      color:#00ff88;
    }
    .shop-car.selected {
      border-color:#ffcc00;
      color:#ffcc00;
    }
    #message {
      text-align:center;
      font-size:13px;
      color:#ff88ff;
      min-height:18px;
    }
  </style>
</head>
<body>
  <div id="ui">
    Cash: $<span id="cashDisplay">0</span> â€”
    Current Car: <span id="carDisplay">Starter</span>
    <div style="font-size:12px;color:#888;">
      Controls: A / D or Left / Right to switch lanes. W / Up Arrow to accelerate.
    </div>
  </div>
  <div id="shop"></div>
  <canvas id="gameCanvas" width="400" height="600"></canvas>
  <div id="message"></div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const cashDisplay = document.getElementById("cashDisplay");
    const carDisplay = document.getElementById("carDisplay");
    const shopDiv = document.getElementById("shop");
    const messageDiv = document.getElementById("message");

    const lanes = [70, 150, 230, 310];

    let keys = {};
    window.addEventListener("keydown", e => keys[e.key] = true);
    window.addEventListener("keyup", e => keys[e.key] = false);

    // Car definitions
    const cars = [
      { id: "Starter", name: "Street Starter", price: 0, speed: 4, accel: 0.12, color: "#00eaff" },
      { id: "Sprint", name: "Neon Sprint", price: 25000, speed: 5, accel: 0.14, color: "#ffcc00" },
      { id: "Viper", name: "Night Viper", price: 80000, speed: 6, accel: 0.16, color: "#ff55aa" },
      { id: "Phantom", name: "Night Phantom", price: 250000, speed: 7.5, accel: 0.18, color: "#00ff88" }
    ];

    let ownedCars = ["Starter"];
    let selectedCarId = "Starter";
    let cash = 0;

    let player = {
      laneIndex: 1,
      progress: 0,
      speed: 0
    };

    const aiCars = [
      { laneIndex: 0, progress: 0, speed: 0, base: 3.6 },
      { laneIndex: 2, progress: 0, speed: 0, base: 3.8 },
      { laneIndex: 3, progress: 0, speed: 0, base: 4.0 }
    ];

    let traffic = [];
    let raceLength = 3500;
    let running = false;
    let gameOver = false;
    let lastTime = performance.now();

    function loadState() {
      const storedCash = localStorage.getItem("ngp_cash");
      const storedOwned = localStorage.getItem("ngp_ownedCars");
      const storedSelected = localStorage.getItem("ngp_selectedCar");

      if (storedCash) cash = parseInt(storedCash,10);
      if (storedOwned) ownedCars = JSON.parse(storedOwned);
      if (storedSelected && ownedCars.includes(storedSelected)) selectedCarId = storedSelected;

      updateUI();
    }

    function saveState() {
      localStorage.setItem("ngp_cash", cash);
      localStorage.setItem("ngp_ownedCars", JSON.stringify(ownedCars));
      localStorage.setItem("ngp_selectedCar", selectedCarId);
    }

    function updateUI() {
      cashDisplay.textContent = cash;
      const car = cars.find(c => c.id === selectedCarId);
      carDisplay.textContent = car ? car.name : "Unknown";
      buildShop();
    }

    function buildShop() {
      shopDiv.innerHTML = "";
      cars.forEach(car => {
        const div = document.createElement("div");
        div.className = "shop-car";
        if (ownedCars.includes(car.id)) div.classList.add("owned");
        if (car.id === selectedCarId) div.classList.add("selected");
        div.textContent = `${car.name} ($${car.price.toLocaleString()})`;
        div.onclick = () => handleShopClick(car);
        shopDiv.appendChild(div);
      });
    }

    function handleShopClick(car) {
      if (ownedCars.includes(car.id)) {
        selectedCarId = car.id;
        message("Selected: " + car.name);
      } else {
        if (cash >= car.price) {
          cash -= car.price;
          ownedCars.push(car.id);
          selectedCarId = car.id;
          message("Purchased: " + car.name);
        } else {
          message("Not enough cash for " + car.name);
        }
      }
      saveState();
      updateUI();
    }

    function resetRace() {
      player.laneIndex = 1;
      player.progress = 0;
      player.speed = 0;

      aiCars.forEach((ai, i) => {
        ai.laneIndex = i;
        ai.progress = 0;
        ai.speed = 0;
      });

      traffic = [];
      gameOver = false;
      running = true;
      message("Race started! Accelerate with W / Up Arrow.");
    }

    function message(text) {
      messageDiv.textContent = text;
    }

    function spawnTraffic() {
      const laneIndex = Math.floor(Math.random()*lanes.length);
      traffic.push({
        laneIndex,
        progress: player.progress + 200 + Math.random()*400
      });
    }

    function updateRace(dt) {
      if (!running || gameOver) return;

      const car = cars.find(c => c.id === selectedCarId);

      // ACCELERATION
      if (keys["w"] || keys["ArrowUp"]) {
        player.speed += car.accel * dt;
        if (player.speed > car.speed) player.speed = car.speed;
      } else {
        player.speed *= 0.98;
      }

      // LANE SWITCHING
      if ((keys["a"] || keys["ArrowLeft"]) && player.laneIndex > 0) {
        player.laneIndex--;
        keys["a"] = keys["ArrowLeft"] = false;
      }
      if ((keys["d"] || keys["ArrowRight"]) && player.laneIndex < lanes.length-1) {
        player.laneIndex++;
        keys["d"] = keys["ArrowRight"] = false;
      }

      // MOVE PLAYER
      player.progress += player.speed * dt;

      // AI MOVEMENT
      aiCars.forEach(ai => {
        ai.speed += 0.1 * dt;
        if (ai.speed > ai.base) ai.speed = ai.base;
        ai.progress += ai.speed * dt;
      });

      // TRAFFIC
      if (Math.random() < 0.03) spawnTraffic();

      traffic.forEach(t => {
        if (t.laneIndex === player.laneIndex &&
            Math.abs(t.progress - player.progress) < 50) {
          player.speed *= 0.4;
          message("You hit traffic!");
        }
      });

      // FINISH
      if (player.progress >= raceLength || aiCars.some(ai => ai.progress >= raceLength)) {
        running = false;
        gameOver = true;
        handleFinish();
      }
    }

    function handleFinish() {
      const racers = [
        { name: "You", progress: player.progress, type: "player" },
        { name: "AI 1", progress: aiCars[0].progress },
        { name: "AI 2", progress: aiCars[1].progress },
        { name: "AI 3", progress: aiCars[2].progress }
      ];

      racers.sort((a,b) => b.progress - a.progress);
      const place = racers.findIndex(r => r.type === "player") + 1;

      let reward = 0;
      if (place === 1) reward = 15000;
      else if (place === 2) reward = 8000;
      else if (place === 3) reward = 4000;
      else reward = 1500;

      cash += reward;
      saveState();
      updateUI();

      message(`Finished #${place}! Earned $${reward.toLocaleString()}. Press R to race again.`);
    }

    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const scrollY = 300 - (player.progress * 0.05);

      // ROAD
      ctx.fillStyle = "#050509";
      ctx.fillRect(40,0,canvas.width-80,canvas.height);

      // LANE LINES
      ctx.strokeStyle = "#222237";
      ctx.lineWidth = 2;
      lanes.forEach(x => {
        ctx.beginPath();
        ctx.moveTo(x,0);
        ctx.lineTo(x,canvas.height);
        ctx.stroke();
      });

      // FINISH LINE
      const finishY = scrollY + raceLength * 0.05;
      if (finishY > -50 && finishY < canvas.height+50) {
        ctx.fillStyle="#ffffff22";
        for (let i=0;i<10;i++) {
          const xStart = 40 + (i%2)*40;
          ctx.fillRect(xStart, finishY, 40, 10);
        }
      }

      // TRAFFIC
      traffic.forEach(t => {
        const y = scrollY + t.progress * 0.05;
        if (y > -60 && y < canvas.height+40) {
          const x = lanes[t.laneIndex];
          ctx.fillStyle="#ff4444";
          ctx.fillRect(x-18, y-30, 36, 50);
        }
      });

      // AI CARS
      aiCars.forEach((ai, idx) => {
        const y = scrollY + ai.progress * 0.05;
        if (y > -60 && y < canvas.height+40) {
          const x = lanes[ai.laneIndex];
          ctx.fillStyle = ["#ff66aa","#ffaa44","#aa66ff"][idx];
          ctx.fillRect(x-18, y-30, 36, 50);
        }
      });

      // PLAYER CAR
      const px = lanes[player.laneIndex];
      const py = scrollY + player.progress * 0.05;
      const selectedCar = cars.find(c => c.id === selectedCarId);
      ctx.fillStyle = selectedCar.color;
      ctx.fillRect(px-18, py-30, 36, 50);

      if (!running && !gameOver) {
        ctx.fillStyle="rgba(0,0,0,0.6)";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle="#00eaff";
        ctx.font="18px Segoe UI";
        ctx.textAlign="center";
        ctx.fillText("Press R to start a race", canvas.width/2, canvas.height/2);
        ctx.textAlign="start";
      }
    }

    function loop(now) {
      const dt = (now - lastTime)/16.67;
      lastTime = now;
      updateRace(dt);
      draw();
      requestAnimationFrame(loop);
    }

    window.addEventListener("keydown", e => {
      if ((e.key === "r" || e.key === "R") && !running) {
        resetRace();
      }
    });

    loadState();
    buildShop();
    loop(performance.now());
    message("Press R to start your first race.");
  </script>
</body>
</html>
